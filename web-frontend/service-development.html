<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å¼€å‘ - Auto API Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="assets/common-styles.css" rel="stylesheet">
    <script src="assets/common-utils.js"></script>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .dev-container {
            display: flex;
            height: 100vh;
            background: #f5f7fa;
        }

        /* å·¦ä¾§æœåŠ¡æ ‘åŒºåŸŸ */
        .left-panel {
            width: 350px;
            background: white;
            border-right: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
        }

        .left-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .service-filter {
            padding: 16px 20px;
            border-bottom: 1px solid #e8e8e8;
        }

        .filter-group {
            margin-bottom: 12px;
        }

        .filter-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .filter-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .service-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .service-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            border-bottom: 1px solid #f5f5f5;
        }

        .service-item:hover {
            background: #f5f5f5;
        }

        .service-item.active {
            background: #e6f7ff;
            border-left-color: #1890ff;
        }

        .service-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .service-item-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .service-item-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .service-item-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        .service-item-method {
            font-weight: 500;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 11px;
        }

        .service-item-path {
            font-family: monospace;
            background: #f5f5f5;
            padding: 1px 4px;
            border-radius: 2px;
        }

        /* å³ä¾§ç¼–è¾‘å™¨åŒºåŸŸ */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .right-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .service-path {
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .service-basic-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .service-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .service-description {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .datasource-info {
            background: #f0f2f5;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #666;
        }

        /* ä¸»ç¼–è¾‘åŒºåŸŸ */
        .main-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .editor-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #999;
        }

        .placeholder-content h3 {
            color: #666;
            margin-bottom: 8px;
        }

        .sql-editor-wrapper {
            flex: 1;
            position: relative;
            min-height: 400px;
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }
        
        #sql-editor {
            height: 100%;
            width: 100%;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .required {
            color: #ff4d4f;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px 20px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .field-error {
            color: #ff4d4f;
            font-size: 12px;
            margin-top: 4px;
        }

        /* å‚æ•°é…ç½®é¢æ¿ */
        .parameter-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .parameter-panel.show {
            right: 0;
        }

        .param-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }

        .param-panel-title {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .param-panel-close {
            background: none;
            border: none;
            font-size: 16px;
            color: #999;
            cursor: pointer;
            padding: 4px;
        }

        .param-panel-close:hover {
            color: #333;
        }

        .param-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .param-section {
            margin-bottom: 16px;
        }

        .param-section:last-child {
            margin-bottom: 0;
        }

        .param-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .param-section-header:hover {
            background: #e9ecef;
        }

        .param-section-header h4 {
            margin: 0;
            font-size: 14px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-collapse-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .param-section.collapsed .section-collapse-icon {
            transform: rotate(-90deg);
        }

        .param-section-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            margin-top: 8px;
            max-height: 1000px; /* é»˜è®¤å±•å¼€çŠ¶æ€ */
        }

        .param-section.collapsed .param-section-content {
            max-height: 0;
            margin-top: 0;
        }

        .param-section-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .param-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .param-item {
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            background: white;
            margin-bottom: 6px;
            overflow: hidden;
        }

        .param-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e8e8e8;
            cursor: pointer;
            user-select: none;
        }

        .param-item-header:hover {
            background: #e9ecef;
        }

        .param-item-title {
            font-weight: 500;
            font-size: 13px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .param-collapse-icon {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .param-item.collapsed .param-collapse-icon {
            transform: rotate(-90deg);
        }

        .param-form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 3fr;
            gap: 8px;
            align-items: center;
            padding: 8px 12px;
        }

        .param-form-grid .form-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .param-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            max-height: 500px; /* é»˜è®¤å±•å¼€çŠ¶æ€ */
        }

        .param-item.collapsed .param-content {
            max-height: 0;
        }

        .param-form-grid label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .param-item-name {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .param-item-name:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .param-item-actions {
            display: flex;
            gap: 4px;
        }

        .param-item-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 12px;
        }

        .param-item-action:hover {
            background: #e8e8e8;
        }

        .nested-config {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border: 1px dashed #d1d5db;
            border-radius: 4px;
        }

        .nested-params {
            margin-bottom: 12px;
        }

        .nested-param-item {
            padding: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .nested-param-item:last-child {
            margin-bottom: 0;
        }

        .param-type-select,
        .param-description,
        .nested-param-name,
        .nested-param-type,
        .nested-param-description {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 12px;
        }

        .param-item-name {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 8px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification-success {
            border-left: 4px solid #52c41a;
        }
        
        .notification-success i {
            color: #52c41a;
        }
        
        .notification-error {
            border-left: 4px solid #ff4d4f;
        }
        
        .notification-error i {
            color: #ff4d4f;
        }
        
        .notification-warning {
            border-left: 4px solid #faad14;
        }
        
        .notification-warning i {
            color: #faad14;
        }
        
        .notification-info {
            border-left: 4px solid #1890ff;
        }
        
        .notification-info i {
            color: #1890ff;
        }

        /* æ–¹æ³•æ ‡ç­¾æ ·å¼ */
        .method-tag {
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        
        .method-tag.get {
            background: #e6f7ff;
            color: #1890ff;
        }
        
        .method-tag.post {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .method-tag.put {
            background: #fff7e6;
            color: #fa8c16;
        }
        
        .method-tag.delete {
            background: #fff1f0;
            color: #ff4d4f;
        }
        
        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-draft {
            background: #fafafa;
            color: #666;
        }
        
        .status-published {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .status-disabled {
            background: #fff1f0;
            color: #ff4d4f;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 28px;
            background: #007acc;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .left-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .dev-container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: 200px;
            }
            
            .right-panel {
                height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body>
    <div class="dev-container">
        <!-- å·¦ä¾§æœåŠ¡æ ‘ -->
        <div class="left-panel">
            <div class="left-panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-sitemap"></i> æœåŠ¡å¼€å‘
                </h2>
                <a href="apiservice-table.html" class="btn btn-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </a>
            </div>

            <div class="service-filter">
                <div class="filter-group">
                    <input type="text" class="filter-input" id="service-search" placeholder="æœç´¢æœåŠ¡...">
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary btn-sm" onclick="showCreateServiceModal()" style="width: 100%;">
                        <i class="fas fa-plus"></i> æ–°å»ºAPIæœåŠ¡
                    </button>
                </div>
            </div>

            <div class="service-list" id="service-list">
                <!-- æœåŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³ä¾§ç¼–è¾‘å™¨ -->
        <div class="right-panel">
            <div class="right-panel-header">
                <div class="service-info" id="service-header" style="display: none;">
                    <div class="service-basic-info">
                        <span class="service-name" id="current-service-name">æœªé€‰æ‹©æœåŠ¡</span>
                        <div class="service-meta">
                            <span class="method-tag" id="current-method">GET</span>
                            <span class="service-path" id="current-service-path">/api/path</span>
                            <span class="datasource-info" id="current-datasource-info">æ•°æ®æº</span>
                        </div>
                        <div class="service-description" id="current-description">æœåŠ¡æè¿°</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary btn-sm" onclick="showParameterPanel()" id="param-btn">
                        <i class="fas fa-sliders-h"></i> å‚æ•°é…ç½®
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="testCurrentService()" id="test-btn">
                        <i class="fas fa-flask"></i> æµ‹è¯•
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="saveCurrentService()" id="save-btn">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="publishCurrentService()" id="publish-btn">
                        <i class="fas fa-rocket"></i> å‘å¸ƒ
                    </button>
                </div>
            </div>

            <!-- ä¸»ç¼–è¾‘åŒºåŸŸ -->
            <div class="main-editor" id="main-editor">
                <div class="editor-placeholder" id="editor-placeholder">
                    <div class="placeholder-content">
                        <i class="fas fa-code" style="font-size: 64px; color: #ddd; margin-bottom: 20px;"></i>
                        <h3>è¯·é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªAPIæœåŠ¡</h3>
                        <p>ä»å·¦ä¾§æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœåŠ¡è¿›è¡Œç¼–è¾‘ï¼Œæˆ–ç‚¹å‡»"æ–°å»ºAPIæœåŠ¡"åˆ›å»ºæ–°æœåŠ¡</p>
                    </div>
                </div>
                <div class="sql-editor-wrapper" id="sql-editor-wrapper" style="display: none;">
                    <div class="sql-editor-toolbar" style="padding: 8px 12px; border-bottom: 1px solid #e8e8e8; background: #fafbfc; display: flex; align-items: center; gap: 12px;">
                        <label style="font-size: 12px; color: #666; margin: 0;">æ•°æ®åº“:</label>
                        <select id="database-selector" style="padding: 4px 8px; border: 1px solid #d9d9d9; border-radius: 3px; font-size: 12px; background: white;">
                            <option value="">é€‰æ‹©æ•°æ®åº“...</option>
                        </select>
                        <button class="btn btn-sm btn-secondary" onclick="refreshDatabaseSchema()" title="åˆ·æ–°æ•°æ®åº“ç»“æ„">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <div id="sql-editor"></div>
                </div>
            </div>
        </div>

        <!-- å‚æ•°é…ç½®ä¾§è¾¹é¢æ¿ -->
        <div class="parameter-panel" id="parameter-panel">
            <div class="param-panel-header">
                <h3 class="param-panel-title">å‚æ•°é…ç½®</h3>
                <button class="param-panel-close" onclick="hideParameterPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="param-panel-content">
                <div class="param-section" id="input-param-section">
                    <div class="param-section-header" onclick="toggleParamSection('input-param-section')">
                        <h4>
                            <i class="fas fa-chevron-down section-collapse-icon"></i>
                            <i class="fas fa-arrow-right" style="color: #28a745; margin-right: 4px;"></i>
                            è¾“å…¥å‚æ•°
                            <span class="param-count" id="input-param-count">(0)</span>
                        </h4>
                        <div class="param-section-actions">
                            <button class="btn btn-sm btn-secondary" onclick="addInputParameter(); event.stopPropagation();">
                                <i class="fas fa-plus"></i> æ·»åŠ 
                            </button>
                        </div>
                    </div>
                    <div class="param-section-content">
                        <div class="param-list" id="input-params">
                            <!-- è¾“å…¥å‚æ•°åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>

                <div class="param-section" id="output-param-section">
                    <div class="param-section-header" onclick="toggleParamSection('output-param-section')">
                        <h4>
                            <i class="fas fa-chevron-down section-collapse-icon"></i>
                            <i class="fas fa-arrow-left" style="color: #1890ff; margin-right: 4px;"></i>
                            è¾“å‡ºç»“æ„
                            <span class="param-count" id="output-param-count">(0)</span>
                        </h4>
                        <div class="param-section-actions">
                            <button class="btn btn-sm btn-secondary" onclick="addOutputParameter(); event.stopPropagation();">
                                <i class="fas fa-plus"></i> æ·»åŠ 
                            </button>
                        </div>
                    </div>
                    <div class="param-section-content">
                        <div class="param-list" id="output-params">
                            <!-- è¾“å‡ºå‚æ•°åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="param-panel-footer" style="padding: 16px 20px; border-top: 1px solid #e8e8e8; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideParameterPanel()">
                    å–æ¶ˆ
                </button>
                <button class="btn btn-primary" onclick="saveParameterConfig(); hideParameterPanel();">
                    <i class="fas fa-save"></i> åº”ç”¨é…ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºæœåŠ¡å¼¹çª— -->
    <div class="modal-overlay" id="create-service-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºAPIæœåŠ¡</h3>
                <button class="modal-close" onclick="hideCreateServiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="create-service-form">
                    <div class="form-group">
                        <label>æœåŠ¡åç§° <span class="required">*</span></label>
                        <input type="text" id="new-service-name" name="name" placeholder="è¯·è¾“å…¥æœåŠ¡åç§°" required>
                        <div class="field-error" id="name-error" style="display: none;"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>è¯·æ±‚æ–¹æ³• <span class="required">*</span></label>
                            <select id="new-service-method" name="method" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>URLè·¯å¾„ <span class="required">*</span></label>
                            <input type="text" id="new-service-path" name="path" placeholder="/api/your-endpoint" required>
                            <div class="field-error" id="path-error" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ•°æ®æºç±»å‹ <span class="required">*</span></label>
                            <select id="new-datasource-type" required onchange="filterDatasourcesByType()">
                                <option value="">è¯·é€‰æ‹©æ•°æ®æºç±»å‹</option>
                                <option value="MYSQL">ğŸ¬ MySQL</option>
                                <option value="POSTGRESQL">ğŸ˜ PostgreSQL</option>
                                <option value="H2">ğŸ’¾ H2</option>
                                <option value="ORACLE">ğŸ¢ Oracle</option>
                                <option value="MONGODB">ğŸƒ MongoDB</option>
                                <option value="ELASTICSEARCH">ğŸ” Elasticsearch</option>
                                <option value="CLICKHOUSE">ğŸ“Š ClickHouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®æº <span class="required">*</span></label>
                            <select id="new-service-datasource" name="dataSourceId" required>
                                <option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æºç±»å‹</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æœåŠ¡æè¿°</label>
                        <textarea id="new-service-description" name="description" placeholder="è¯·è¾“å…¥æœåŠ¡æè¿°" rows="3"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCreateServiceModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createService()" id="create-service-btn">
                    <i class="fas fa-plus"></i> åˆ›å»ºæœåŠ¡
                </button>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-circle" id="status-indicator" style="color: #28a745;"></i>
            <span id="status-text">å°±ç»ª</span>
        </div>
        <div class="status-item">
            <i class="fas fa-database"></i>
            <span id="current-datasource">æœªé€‰æ‹©æ•°æ®æº</span>
        </div>
        <div class="status-item">
            <i class="fas fa-clock"></i>
            <span id="last-saved">æœªä¿å­˜</span>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        
        // å…¨å±€çŠ¶æ€
        let currentService = null;
        let currentServiceId = null;
        let isEditMode = false;
        let sqlEditor, paramsEditor, responseEditor;
        let datasources = [];
        let services = [];
        let datasourcesLoaded = false;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            const serviceId = urlParams.get('id');
            if (serviceId) {
                isEditMode = true;
                currentServiceId = serviceId;
            }

            // åˆå§‹åŒ–Monacoç¼–è¾‘å™¨
            initializeEditors();
            
            // åŠ è½½æ•°æ®
            loadDataSources();
            loadServices();
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½æœåŠ¡æ•°æ®
            if (isEditMode && currentServiceId) {
                loadServiceForEdit(currentServiceId);
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents();
        });

        // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®åº“æ¶æ„
        let databaseSchema = {};
        let currentDataSource = null;

        // åˆå§‹åŒ–Monacoç¼–è¾‘å™¨
        function initializeEditors() {
            require.config({ 
                paths: { 
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' 
                }
            });

            require(['vs/editor/editor.main'], function() {
                try {
                    // SQLç¼–è¾‘å™¨
                    const sqlEditorContainer = document.getElementById('sql-editor');
                    if (sqlEditorContainer) {
                        sqlEditor = monaco.editor.create(sqlEditorContainer, {
                            value: 'SELECT * FROM your_table WHERE condition = :param',
                            language: 'sql',
                            theme: 'vs',
                            fontSize: 14,
                            minimap: { enabled: false },
                            scrollBeyondLastLine: false,
                            automaticLayout: true,
                            suggestOnTriggerCharacters: true,
                            quickSuggestions: true
                        });

                        // è®¾ç½®ç¼–è¾‘å™¨å˜åŒ–ç›‘å¬
                        sqlEditor.onDidChangeModelContent(() => {
                            updateStatus('ç¼–è¾‘ä¸­...', 'warning');
                        });

                        // æ³¨å†ŒSQLè‡ªåŠ¨å®Œæˆæä¾›ç¨‹åº
                        registerSqlCompletionProvider();
                        
                        console.log('âœ… SQLç¼–è¾‘å™¨åˆå§‹åŒ–æˆåŠŸ');
                    } else {
                        console.error('âŒ æ‰¾ä¸åˆ°sql-editorå®¹å™¨');
                    }
                } catch (error) {
                    console.error('âŒ ç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                }
            });
        }

        // æ³¨å†ŒSQLè‡ªåŠ¨å®Œæˆæä¾›ç¨‹åº
        function registerSqlCompletionProvider() {
            if (!monaco) return;
            
            monaco.languages.registerCompletionItemProvider('sql', {
                provideCompletionItems: function(model, position) {
                    const suggestions = [];
                    
                    // SQLå…³é”®å­—å»ºè®®
                    const sqlKeywords = [
                        'SELECT', 'FROM', 'WHERE', 'JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN',
                        'ORDER BY', 'GROUP BY', 'HAVING', 'INSERT', 'UPDATE', 'DELETE', 'CREATE',
                        'DROP', 'ALTER', 'INDEX', 'DISTINCT', 'UNION', 'LIMIT', 'OFFSET',
                        'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'BETWEEN', 'LIKE', 'IS NULL', 'IS NOT NULL'
                    ];
                    
                    sqlKeywords.forEach(keyword => {
                        suggestions.push({
                            label: keyword,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertText: keyword
                        });
                    });
                    
                    // è¡¨åå»ºè®®
                    if (databaseSchema.tables) {
                        databaseSchema.tables.forEach(table => {
                            suggestions.push({
                                label: table.name,
                                kind: monaco.languages.CompletionItemKind.Class,
                                insertText: table.name,
                                detail: `è¡¨: ${table.name}`,
                                documentation: table.comment || ''
                            });
                        });
                    }
                    
                    // å­—æ®µåå»ºè®®
                    if (databaseSchema.tables) {
                        databaseSchema.tables.forEach(table => {
                            if (table.columns) {
                                table.columns.forEach(column => {
                                    suggestions.push({
                                        label: column.name,
                                        kind: monaco.languages.CompletionItemKind.Field,
                                        insertText: column.name,
                                        detail: `${table.name}.${column.name} (${column.type})`,
                                        documentation: column.comment || ''
                                    });
                                });
                            }
                        });
                    }
                    
                    return { suggestions: suggestions };
                }
            });
        }

        // åŠ è½½æ•°æ®æºåˆ—è¡¨
        async function loadDataSources() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®æº...');
                const response = await fetch(`${API_BASE_URL}/api/datasources`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        datasources = result.data;
                        datasourcesLoaded = true;
                        console.log('âœ… æ•°æ®æºåŠ è½½æˆåŠŸ:', datasources);
                        populateDataSourceSelects();
                        rebuildServiceTree();
                    } else {
                        console.error('âŒ æ•°æ®æºAPIè¿”å›å¤±è´¥:', result.message);
                    }
                } else {
                    console.error('âŒ æ•°æ®æºAPIè¯·æ±‚å¤±è´¥: HTTP', response.status);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®æºå¼‚å¸¸:', error);
            }
        }

        // å¡«å……æ•°æ®æºé€‰æ‹©æ¡†
        function populateDataSourceSelects() {
            // å¡«å……æ–°å»ºæœåŠ¡å¼¹çª—ä¸­çš„æ•°æ®æºç±»å‹é€‰æ‹©æ¡†å·²ç»åœ¨HTMLä¸­é™æ€å®šä¹‰
            // è¿™é‡Œåªéœ€è¦ç¡®ä¿æ•°æ®æºåˆ—è¡¨æ•°æ®å¯ç”¨
            console.log('å·²åŠ è½½æ•°æ®æº:', datasources.length, 'ä¸ª');
            if (datasources && datasources.length > 0) {
                console.log('æ•°æ®æºè¯¦æƒ…:', datasources);
                datasources.forEach(ds => {
                    console.log(`- ${ds.name}: ${ds.type} @ ${ds.host}:${ds.port}`);
                });
            }
        }

        // åŠ è½½APIæœåŠ¡åˆ—è¡¨
        async function loadServices() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/services`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        services = result.data.content || result.data || [];
                        console.log('å·²åŠ è½½æœåŠ¡:', services.length, 'ä¸ª');
                        rebuildServiceTree();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // é‡å»ºæœåŠ¡åˆ—è¡¨
        function rebuildServiceTree() {
            const serviceList = document.getElementById('service-list');
            
            if (!services || services.length === 0) {
                serviceList.innerHTML = `
                    <div class="service-item" style="text-align: center; color: #999; padding: 40px 20px;">
                        <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                        æš‚æ— æœåŠ¡ï¼Œç‚¹å‡»ä¸Šæ–¹æ–°å»ºæŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªæœåŠ¡
                    </div>
                `;
                return;
            }

            // åº”ç”¨æœç´¢è¿‡æ»¤
            const searchTerm = document.getElementById('service-search').value.toLowerCase();
            const filteredServices = services.filter(service => {
                if (!searchTerm) return true;
                return service.name.toLowerCase().includes(searchTerm) ||
                       (service.path && service.path.toLowerCase().includes(searchTerm)) ||
                       (service.description && service.description.toLowerCase().includes(searchTerm));
            });

            if (filteredServices.length === 0) {
                serviceList.innerHTML = `
                    <div class="service-item" style="text-align: center; color: #999; padding: 40px 20px;">
                        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                        æœªæ‰¾åˆ°åŒ¹é…çš„æœåŠ¡
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“æœåŠ¡åˆ—è¡¨
            const serviceItems = filteredServices.map(service => {
                const datasource = datasources.find(ds => ds.id === service.dataSourceId);
                const isActive = service.id == currentServiceId ? 'active' : '';
                
                return `
                    <div class="service-item ${isActive}" onclick="loadService(${service.id})">
                        <div class="service-item-header">
                            <span class="service-item-name">${service.name}</span>
                            <span class="service-item-status ${getStatusClass(service.status || 'DRAFT', 'service')}">${getStatusText(service.status || 'DRAFT', 'service')}</span>
                        </div>
                        <div class="service-item-meta">
                            <span class="service-item-method ${getMethodClass(service.method)}">${service.method || 'GET'}</span>
                            <span class="service-item-path">${service.path || '/api/path'}</span>
                        </div>
                        ${service.description ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${service.description}</div>` : ''}
                        ${datasource ? `<div style="font-size: 11px; color: #666; margin-top: 4px;"><i class="${getDatabaseIcon(datasource.type)}" style="margin-right: 4px;"></i>${datasource.name}</div>` : ''}
                    </div>
                `;
            }).join('');

            serviceList.innerHTML = serviceItems;
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æœåŠ¡æœç´¢
            document.getElementById('service-search').addEventListener('input', function() {
                rebuildServiceTree();
            });

            // æœåŠ¡æœç´¢å›è½¦äº‹ä»¶
            document.getElementById('service-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    rebuildServiceTree();
                }
            });
        }

        // æ•°æ®æºç±»å‹ç­›é€‰
        function filterDataSources() {
            const typeFilter = document.getElementById('datasource-type-filter').value;
            const datasourceSelect = document.getElementById('datasource-filter');
            
            datasourceSelect.innerHTML = '<option value="">å…¨éƒ¨æ•°æ®æº</option>';
            
            const filteredDatasources = typeFilter ? 
                datasources.filter(ds => ds.type === typeFilter) : 
                datasources;
            
            filteredDatasources.forEach(datasource => {
                const option = document.createElement('option');
                option.value = datasource.id;
                option.textContent = `${datasource.name} (${datasource.type})`;
                datasourceSelect.appendChild(option);
            });
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            // æ›´æ–°é€‰é¡¹å¡çŠ¶æ€
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.editor-tab:nth-child(${getTabIndex(tabName)})`).classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // å¦‚æœæ˜¯ç¼–è¾‘å™¨é€‰é¡¹å¡ï¼Œè§¦å‘å¸ƒå±€æ›´æ–°
            if (['sql', 'params', 'response'].includes(tabName)) {
                setTimeout(() => {
                    const editor = getEditorByTab(tabName);
                    if (editor) {
                        editor.layout();
                    }
                }, 100);
            }
        }

        function getTabIndex(tabName) {
            const tabs = ['config', 'sql', 'params', 'response'];
            return tabs.indexOf(tabName) + 1;
        }

        function getEditorByTab(tabName) {
            switch(tabName) {
                case 'sql': return sqlEditor;
                case 'params': return paramsEditor;
                case 'response': return responseEditor;
                default: return null;
            }
        }

        // åˆ›å»ºæ–°æœåŠ¡
        function createNewService() {
            isEditMode = false;
            currentServiceId = null;
            currentService = null;
            
            clearForm();
            updateServiceInfo(null);
            updateStatus('åˆ›å»ºæ–°æœåŠ¡', 'info');
            
            // é‡æ–°æ¸²æŸ“æœåŠ¡åˆ—è¡¨ä»¥ç§»é™¤activeçŠ¶æ€
            rebuildServiceTree();
        }

        // åŠ è½½æœåŠ¡è¿›è¡Œç¼–è¾‘
        async function loadService(serviceId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/services/${serviceId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentService = result.data;
                        currentServiceId = serviceId;
                        isEditMode = true;
                        
                        populateForm(currentService);
                        updateServiceInfo(currentService);
                        loadParameterConfig(currentService);
                        updateStatus('æœåŠ¡å·²åŠ è½½', 'success');
                        
                        // æ›´æ–°æœåŠ¡åˆ—è¡¨çš„activeçŠ¶æ€
                        rebuildServiceTree();
                    }
                }
            } catch (error) {
                updateStatus('åŠ è½½æœåŠ¡å¤±è´¥', 'error');
                console.error('åŠ è½½æœåŠ¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç¼–è¾‘æ¨¡å¼çš„æœåŠ¡
        function loadServiceForEdit(serviceId) {
            loadService(serviceId);
        }

        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearForm() {
            if (sqlEditor) sqlEditor.setValue('SELECT * FROM your_table WHERE condition = :param');
        }

        // å¡«å……ç¼–è¾‘å™¨
        function populateForm(service) {
            console.log('å¼€å§‹å¡«å……ç¼–è¾‘å™¨ï¼ŒæœåŠ¡:', service);
            
            // æ˜¾ç¤ºç¼–è¾‘å™¨ï¼Œéšè—å ä½ç¬¦
            const placeholder = document.getElementById('editor-placeholder');
            const wrapper = document.getElementById('sql-editor-wrapper');
            
            if (placeholder && wrapper) {
                placeholder.style.display = 'none';
                wrapper.style.display = 'block';
                console.log('âœ… ç¼–è¾‘å™¨å®¹å™¨æ˜¾ç¤ºçŠ¶æ€å·²åˆ‡æ¢');
            }
            
            // è®¾ç½®SQLå†…å®¹
            if (sqlEditor) {
                const sqlContent = service.sqlContent || 'SELECT * FROM your_table WHERE condition = :param';
                sqlEditor.setValue(sqlContent);
                console.log('âœ… SQLå†…å®¹å·²è®¾ç½®:', sqlContent);
                
                // å»¶è¿Ÿè§¦å‘ç¼–è¾‘å™¨å¸ƒå±€æ›´æ–°ï¼Œç¡®ä¿å®¹å™¨å·²æ˜¾ç¤º
                setTimeout(() => {
                    if (sqlEditor) {
                        sqlEditor.layout();
                        sqlEditor.focus();
                        console.log('âœ… ç¼–è¾‘å™¨å¸ƒå±€å·²æ›´æ–°');
                    }
                }, 200);
            } else {
                console.error('âŒ SQLç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
                // å¦‚æœç¼–è¾‘å™¨æœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–
                initializeEditors();
            }
        }

        // æ›´æ–°æœåŠ¡ä¿¡æ¯æ˜¾ç¤º
        function updateServiceInfo(service) {
            const serviceHeader = document.getElementById('service-header');
            const serviceName = document.getElementById('current-service-name');
            const serviceMethod = document.getElementById('current-method');
            const servicePath = document.getElementById('current-service-path');
            const datasourceInfo = document.getElementById('current-datasource-info');
            const description = document.getElementById('current-description');

            if (service) {
                serviceHeader.style.display = 'flex';
                serviceName.textContent = service.name || 'æœªå‘½åæœåŠ¡';
                serviceMethod.textContent = service.method || 'GET';
                serviceMethod.className = `method-tag ${getMethodClass(service.method)}`;
                servicePath.textContent = service.path || '/api/path';
                
                // æ˜¾ç¤ºæ•°æ®æºä¿¡æ¯
                const datasource = datasources.find(ds => ds.id === service.dataSourceId);
                if (datasource) {
                    datasourceInfo.innerHTML = `<i class="${getDatabaseIcon(datasource.type)}" style="margin-right: 4px;"></i>${datasource.name}`;
                    // è®¾ç½®å½“å‰æ•°æ®æºå¹¶åŠ è½½æ•°æ®åº“æ¶æ„
                    currentDataSource = datasource;
                    loadDatabaseSchema(datasource);
                } else {
                    datasourceInfo.textContent = 'æœªçŸ¥æ•°æ®æº';
                    currentDataSource = null;
                }
                
                description.textContent = service.description || 'æ— æè¿°';
                
                // æ›´æ–°çŠ¶æ€æ æ•°æ®æºä¿¡æ¯
                if (datasource) {
                    document.getElementById('current-datasource').textContent = `${datasource.name} (${datasource.type})`;
                }
            } else {
                serviceHeader.style.display = 'none';
                serviceName.textContent = 'æœªé€‰æ‹©æœåŠ¡';
                document.getElementById('current-datasource').textContent = 'æœªé€‰æ‹©æ•°æ®æº';
                currentDataSource = null;
            }
        }

        // åŠ è½½æ•°æ®åº“æ¶æ„
        async function loadDatabaseSchema(datasource) {
            if (!datasource) return;
            
            try {
                console.log('æ­£åœ¨åŠ è½½æ•°æ®åº“æ¶æ„:', datasource.name);
                const response = await fetch(`${API_BASE_URL}/api/datasources/${datasource.id}/schema`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        databaseSchema = result.data;
                        populateDatabaseSelector(databaseSchema);
                        console.log('âœ… æ•°æ®åº“æ¶æ„åŠ è½½æˆåŠŸ:', databaseSchema);
                    } else {
                        console.warn('âš ï¸ æ•°æ®åº“æ¶æ„åŠ è½½å¤±è´¥:', result.message);
                        // å¦‚æœåç«¯æœªå®ç°ï¼Œåˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        loadMockDatabaseSchema(datasource);
                    }
                } else {
                    console.warn('âš ï¸ æ•°æ®åº“æ¶æ„APIè¯·æ±‚å¤±è´¥:', response.status);
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    loadMockDatabaseSchema(datasource);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®åº“æ¶æ„å¼‚å¸¸:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                loadMockDatabaseSchema(datasource);
            }
        }

        // åŠ è½½æ¨¡æ‹Ÿæ•°æ®åº“æ¶æ„ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        function loadMockDatabaseSchema(datasource) {
            console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®åº“æ¶æ„');
            
            if (datasource.type === 'H2') {
                databaseSchema = {
                    databases: ['PUBLIC'],
                    tables: [
                        {
                            name: 'users',
                            comment: 'ç”¨æˆ·è¡¨',
                            columns: [
                                { name: 'id', type: 'BIGINT', comment: 'ç”¨æˆ·ID' },
                                { name: 'username', type: 'VARCHAR(100)', comment: 'ç”¨æˆ·å' },
                                { name: 'email', type: 'VARCHAR(255)', comment: 'é‚®ç®±' },
                                { name: 'created_at', type: 'TIMESTAMP', comment: 'åˆ›å»ºæ—¶é—´' },
                                { name: 'updated_at', type: 'TIMESTAMP', comment: 'æ›´æ–°æ—¶é—´' }
                            ]
                        },
                        {
                            name: 'api_services',
                            comment: 'APIæœåŠ¡è¡¨',
                            columns: [
                                { name: 'id', type: 'BIGINT', comment: 'æœåŠ¡ID' },
                                { name: 'name', type: 'VARCHAR(255)', comment: 'æœåŠ¡åç§°' },
                                { name: 'path', type: 'VARCHAR(500)', comment: 'APIè·¯å¾„' },
                                { name: 'method', type: 'VARCHAR(10)', comment: 'HTTPæ–¹æ³•' },
                                { name: 'sql_content', type: 'CLOB', comment: 'SQLå†…å®¹' },
                                { name: 'data_source_id', type: 'BIGINT', comment: 'æ•°æ®æºID' }
                            ]
                        },
                        {
                            name: 'data_sources',
                            comment: 'æ•°æ®æºè¡¨',
                            columns: [
                                { name: 'id', type: 'BIGINT', comment: 'æ•°æ®æºID' },
                                { name: 'name', type: 'VARCHAR(255)', comment: 'æ•°æ®æºåç§°' },
                                { name: 'type', type: 'VARCHAR(50)', comment: 'æ•°æ®æºç±»å‹' },
                                { name: 'host', type: 'VARCHAR(255)', comment: 'ä¸»æœºåœ°å€' },
                                { name: 'port', type: 'INTEGER', comment: 'ç«¯å£' },
                                { name: 'database_name', type: 'VARCHAR(255)', comment: 'æ•°æ®åº“å' }
                            ]
                        }
                    ]
                };
            } else {
                // å…¶ä»–æ•°æ®åº“ç±»å‹çš„æ¨¡æ‹Ÿæ•°æ®
                databaseSchema = {
                    databases: ['test', 'main'],
                    tables: [
                        {
                            name: 'sample_table',
                            comment: 'ç¤ºä¾‹è¡¨',
                            columns: [
                                { name: 'id', type: 'INT', comment: 'ID' },
                                { name: 'name', type: 'VARCHAR(255)', comment: 'åç§°' }
                            ]
                        }
                    ]
                };
            }
            
            populateDatabaseSelector(databaseSchema);
        }

        // å¡«å……æ•°æ®åº“é€‰æ‹©å™¨
        function populateDatabaseSelector(schema) {
            const selector = document.getElementById('database-selector');
            selector.innerHTML = '<option value="">é€‰æ‹©æ•°æ®åº“...</option>';
            
            if (schema.databases && schema.databases.length > 0) {
                schema.databases.forEach(dbName => {
                    const option = document.createElement('option');
                    option.value = dbName;
                    option.textContent = dbName;
                    selector.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = 'default';
                option.textContent = 'é»˜è®¤æ•°æ®åº“';
                selector.appendChild(option);
            }
        }

        // åˆ·æ–°æ•°æ®åº“æ¶æ„
        function refreshDatabaseSchema() {
            if (currentDataSource) {
                loadDatabaseSchema(currentDataSource);
                showNotification('æ­£åœ¨åˆ·æ–°æ•°æ®åº“ç»“æ„...', 'info');
            } else {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœåŠ¡', 'warning');
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, type = 'info') {
            document.getElementById('status-text').textContent = text;
            const indicator = document.getElementById('status-indicator');
            
            const colors = {
                'success': '#28a745',
                'warning': '#ffc107',
                'error': '#dc3545',
                'info': '#17a2b8'
            };
            
            indicator.style.color = colors[type] || colors.info;
        }

        // ä¿å­˜æœåŠ¡
        async function saveCurrentService() {
            const formData = gatherFormData();
            
            if (!validateForm(formData)) {
                return;
            }

            try {
                updateStatus('ä¿å­˜ä¸­...', 'warning');
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­';
                saveBtn.disabled = true;

                let response;
                if (isEditMode && currentServiceId) {
                    response = await fetch(`${API_BASE_URL}/api/services/${currentServiceId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/api/services`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }

                const result = await response.json();
                
                if (result.success) {
                    updateStatus('ä¿å­˜æˆåŠŸ', 'success');
                    document.getElementById('last-saved').textContent = new Date().toLocaleTimeString();
                    
                    if (!isEditMode) {
                        // æ–°å»ºæ¨¡å¼ï¼Œåˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                        isEditMode = true;
                        currentServiceId = result.data.id;
                        currentService = result.data;
                    } else {
                        // æ›´æ–°å½“å‰æœåŠ¡æ•°æ®
                        currentService = { ...currentService, ...result.data };
                        
                        // æ›´æ–°æœ¬åœ°æœåŠ¡åˆ—è¡¨ä¸­çš„å¯¹åº”é¡¹
                        const serviceIndex = services.findIndex(s => s.id === currentServiceId);
                        if (serviceIndex !== -1) {
                            services[serviceIndex] = currentService;
                            rebuildServiceTree(); // é‡æ–°æ¸²æŸ“æœåŠ¡åˆ—è¡¨
                        }
                    }
                    
                    showNotification('ä¿å­˜æˆåŠŸï¼', 'success');
                } else {
                    updateStatus('ä¿å­˜å¤±è´¥', 'error');
                    showNotification('ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                updateStatus('ä¿å­˜å¤±è´¥', 'error');
                showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            } finally {
                const saveBtn = document.getElementById('save-btn');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜';
                saveBtn.disabled = false;
            }
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function gatherFormData() {
            if (!currentService) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœåŠ¡', 'error');
                return null;
            }

            // è‡ªåŠ¨ä¿å­˜å‚æ•°é…ç½®
            const inputParams = collectParameters('input-params');
            const outputParams = collectParameters('output-params');

            return {
                ...currentService,
                sqlContent: sqlEditor ? sqlEditor.getValue() : '',
                requestParams: Object.keys(inputParams).length > 0 ? JSON.stringify(inputParams, null, 2) : '{}',
                responseExample: Object.keys(outputParams).length > 0 ? JSON.stringify(outputParams, null, 2) : '{}',
                enabled: true
            };
        }

        // éªŒè¯è¡¨å•
        function validateForm(formData) {
            if (!formData) {
                return false;
            }
            
            if (!formData.sqlContent) {
                showNotification('è¯·è¾“å…¥SQLæŸ¥è¯¢', 'error');
                return false;
            }
            
            return true;
        }

        // æµ‹è¯•æœåŠ¡
        function testCurrentService() {
            if (!currentService) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœåŠ¡', 'warning');
                return;
            }

            const formData = gatherFormData();
            if (!formData || !formData.sqlContent) {
                showNotification('è¯·è¾“å…¥SQLæŸ¥è¯¢', 'warning');
                return;
            }
            
            updateStatus('æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            showNotification('æµ‹è¯•åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­', 'info');
        }

        // å‘å¸ƒæœåŠ¡
        async function publishCurrentService() {
            if (!currentService || !currentServiceId) {
                showNotification('è¯·å…ˆé€‰æ‹©å¹¶ä¿å­˜æœåŠ¡', 'warning');
                return;
            }
            
            try {
                updateStatus('å‘å¸ƒä¸­...', 'warning');
                const response = await fetch(`${API_BASE_URL}/api/services/${currentServiceId}/status?status=PUBLISHED`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateStatus('å‘å¸ƒæˆåŠŸ', 'success');
                    showNotification('æœåŠ¡å‘å¸ƒæˆåŠŸï¼', 'success');
                    
                    // æ›´æ–°å½“å‰æœåŠ¡çŠ¶æ€
                    if (currentService) {
                        currentService.status = 'PUBLISHED';
                        updateServiceInfo(currentService);
                        
                        // æ›´æ–°æœ¬åœ°æœåŠ¡åˆ—è¡¨ä¸­çš„çŠ¶æ€
                        const serviceIndex = services.findIndex(s => s.id === currentServiceId);
                        if (serviceIndex !== -1) {
                            services[serviceIndex].status = 'PUBLISHED';
                            rebuildServiceTree();
                        }
                    }
                } else {
                    updateStatus('å‘å¸ƒå¤±è´¥', 'error');
                    showNotification('å‘å¸ƒå¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                updateStatus('å‘å¸ƒå¤±è´¥', 'error');
                showNotification('å‘å¸ƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ–°å»ºæœåŠ¡å¼¹çª—
        function showCreateServiceModal() {
            console.log('æ‰“å¼€æ–°å»ºæœåŠ¡å¼¹çª—');
            console.log('æ•°æ®æºåŠ è½½çŠ¶æ€:', datasourcesLoaded);
            console.log('æ•°æ®æºæ•°é‡:', datasources ? datasources.length : 0);
            
            // å¦‚æœæ•°æ®æºå°šæœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½
            if (!datasourcesLoaded || !datasources || datasources.length === 0) {
                console.log('æ•°æ®æºæœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½...');
                loadDataSources().then(() => {
                    console.log('é‡æ–°åŠ è½½æ•°æ®æºå®Œæˆ');
                });
            }
            
            const modal = document.getElementById('create-service-modal');
            modal.classList.add('show');
        }

        function hideCreateServiceModal() {
            const modal = document.getElementById('create-service-modal');
            modal.classList.remove('show');
            clearModalForm();
        }

        function clearModalForm() {
            document.getElementById('create-service-form').reset();
            document.getElementById('name-error').style.display = 'none';
            document.getElementById('path-error').style.display = 'none';
        }

        // æ•°æ®æºç±»å‹å˜æ›´æ—¶ç­›é€‰æ•°æ®æº
        function filterDatasourcesByType() {
            console.log('filterDatasourcesByType è¢«è°ƒç”¨');
            const typeSelect = document.getElementById('new-datasource-type');
            const datasourceSelect = document.getElementById('new-service-datasource');
            
            if (!typeSelect || !datasourceSelect) {
                console.error('âŒ æ•°æ®æºé€‰æ‹©æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            const selectedType = typeSelect.value;
            console.log('é€‰æ‹©çš„æ•°æ®æºç±»å‹:', selectedType);
            console.log('æ•°æ®æºåŠ è½½çŠ¶æ€:', datasourcesLoaded);
            console.log('å½“å‰å…¨å±€æ•°æ®æºæ•°é‡:', datasources ? datasources.length : 0);
            
            if (!datasourcesLoaded) {
                console.warn('âš ï¸ æ•°æ®æºå°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                datasourceSelect.innerHTML = '<option value="">æ•°æ®æºåŠ è½½ä¸­...</option>';
                return;
            }
            
            datasourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®æº</option>';
            
            if (!selectedType) {
                datasourceSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æºç±»å‹</option>';
                console.log('æœªé€‰æ‹©æ•°æ®æºç±»å‹ï¼Œå·²é‡ç½®é€‰æ‹©æ¡†');
                return;
            }
            
            if (!datasources || datasources.length === 0) {
                console.error('âŒ å…¨å±€æ•°æ®æºæ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰');
                datasourceSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨æ•°æ®æº</option>';
                return;
            }
            
            console.log('å¼€å§‹ç­›é€‰æ•°æ®æº...');
            const filteredDatasources = datasources.filter(ds => {
                console.log(`  æ£€æŸ¥: ${ds.name} (ç±»å‹: "${ds.type}") æ˜¯å¦åŒ¹é… "${selectedType}"`);
                return ds.type === selectedType;
            });
            console.log('ç­›é€‰åˆ°çš„æ•°æ®æº:', filteredDatasources.length, 'ä¸ª');
            
            if (filteredDatasources.length === 0) {
                console.log('è¯¥ç±»å‹æ²¡æœ‰åŒ¹é…çš„æ•°æ®æº');
                datasourceSelect.innerHTML = '<option value="">è¯¥ç±»å‹æš‚æ— å¯ç”¨æ•°æ®æº</option>';
                return;
            }
            
            console.log('å¼€å§‹å¡«å……æ•°æ®æºé€‰é¡¹:');
            filteredDatasources.forEach(ds => {
                console.log(`  æ·»åŠ é€‰é¡¹: ${ds.name} (ID: ${ds.id}) @ ${ds.host}:${ds.port}`);
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = `${ds.name} (${ds.host}:${ds.port})`;
                datasourceSelect.appendChild(option);
            });
            console.log('âœ… æ•°æ®æºé€‰é¡¹å¡«å……å®Œæˆï¼Œæ€»è®¡:', datasourceSelect.options.length - 1, 'ä¸ªé€‰é¡¹');
        }

        // æ ¡éªŒæœåŠ¡åç§°æ˜¯å¦é‡å¤
        async function validateServiceName(name, excludeId = null) {
            try {
                const params = new URLSearchParams({ name: name });
                const response = await fetch(`${API_BASE_URL}/api/services?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const existingServices = result.data.content || result.data || [];
                    return excludeId ? 
                        existingServices.some(s => s.name === name && s.id !== excludeId) : 
                        existingServices.some(s => s.name === name);
                }
                return false;
            } catch (error) {
                console.error('æ ¡éªŒæœåŠ¡åç§°å¤±è´¥:', error);
                return false;
            }
        }

        // æ ¡éªŒAPIè·¯å¾„å’Œæ–¹æ³•ç»„åˆæ˜¯å¦é‡å¤
        async function validateServicePath(method, path, excludeId = null) {
            try {
                const params = new URLSearchParams({ method: method, path: path });
                const response = await fetch(`${API_BASE_URL}/api/services?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const existingServices = result.data.content || result.data || [];
                    return excludeId ? 
                        existingServices.some(s => s.method === method && s.path === path && s.id !== excludeId) : 
                        existingServices.some(s => s.method === method && s.path === path);
                }
                return false;
            } catch (error) {
                console.error('æ ¡éªŒAPIè·¯å¾„å¤±è´¥:', error);
                return false;
            }
        }

        // æ˜¾ç¤ºå­—æ®µé”™è¯¯ä¿¡æ¯
        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(fieldId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideFieldError(fieldId) {
            const errorElement = document.getElementById(fieldId);
            errorElement.style.display = 'none';
        }

        // åˆ›å»ºæœåŠ¡
        async function createService() {
            const form = document.getElementById('create-service-form');
            const formData = new FormData(form);
            
            const serviceData = {
                name: formData.get('name').trim(),
                method: formData.get('method'),
                path: formData.get('path').trim(),
                dataSourceId: parseInt(formData.get('dataSourceId')),
                description: formData.get('description').trim()
            };

            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            hideFieldError('name-error');
            hideFieldError('path-error');

            // åŸºç¡€éªŒè¯
            if (!serviceData.name) {
                showFieldError('name-error', 'è¯·è¾“å…¥æœåŠ¡åç§°');
                return;
            }
            
            if (!serviceData.path) {
                showFieldError('path-error', 'è¯·è¾“å…¥APIè·¯å¾„');
                return;
            }
            
            if (!serviceData.path.startsWith('/')) {
                showFieldError('path-error', 'APIè·¯å¾„å¿…é¡»ä»¥/å¼€å¤´');
                return;
            }
            
            if (!serviceData.dataSourceId) {
                showNotification('è¯·é€‰æ‹©æ•°æ®æº', 'error');
                return;
            }

            // ç¦ç”¨åˆ›å»ºæŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const createBtn = document.getElementById('create-service-btn');
            const originalText = createBtn.innerHTML;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ›å»ºä¸­...';
            createBtn.disabled = true;

            try {
                // æ‰§è¡Œé‡å¤æ ¡éªŒ
                const [nameExists, pathExists] = await Promise.all([
                    validateServiceName(serviceData.name),
                    validateServicePath(serviceData.method, serviceData.path)
                ]);

                if (nameExists) {
                    showFieldError('name-error', 'æœåŠ¡åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                    return;
                }

                if (pathExists) {
                    showFieldError('path-error', `${serviceData.method} ${serviceData.path} å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–è·¯å¾„æˆ–æ–¹æ³•`);
                    return;
                }

                // åˆ›å»ºæœåŠ¡
                const response = await fetch(`${API_BASE_URL}/api/services`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...serviceData,
                        sqlContent: 'SELECT * FROM your_table WHERE condition = :param',
                        enabled: true
                    })
                });

                const result = await response.json();
                if (result.success) {
                    hideCreateServiceModal();
                    
                    // ç«‹å³æ·»åŠ æ–°æœåŠ¡åˆ°æœ¬åœ°åˆ—è¡¨
                    const newService = result.data;
                    if (newService) {
                        services.push(newService);
                        rebuildServiceTree();
                        
                        // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„æœåŠ¡
                        setTimeout(() => {
                            loadService(newService.id);
                        }, 100);
                    } else {
                        // å¦‚æœæ²¡æœ‰è¿”å›æ•°æ®ï¼Œé‡æ–°åŠ è½½æœåŠ¡åˆ—è¡¨
                        loadServices();
                    }
                    
                    showNotification('æœåŠ¡åˆ›å»ºæˆåŠŸï¼', 'success');
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                showNotification('åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                createBtn.innerHTML = originalText;
                createBtn.disabled = false;
            }
        }

        // å‚æ•°é…ç½®é¢æ¿
        function showParameterPanel() {
            const panel = document.getElementById('parameter-panel');
            panel.classList.add('show');
        }

        function hideParameterPanel() {
            const panel = document.getElementById('parameter-panel');
            panel.classList.remove('show');
        }

        // æ·»åŠ è¾“å…¥å‚æ•°
        function addInputParameter() {
            const paramList = document.getElementById('input-params');
            const paramItem = createParameterItem('input');
            paramList.appendChild(paramItem);
            updateParameterCount();
        }

        // æ·»åŠ è¾“å‡ºå‚æ•°
        function addOutputParameter() {
            const paramList = document.getElementById('output-params');
            const paramItem = createParameterItem('output');
            paramList.appendChild(paramItem);
            updateParameterCount();
        }

        // åˆ›å»ºå‚æ•°é¡¹
        function createParameterItem(type) {
            const paramId = `${type}-param-${Date.now()}`;
            const paramItem = document.createElement('div');
            paramItem.className = 'param-item';
            paramItem.innerHTML = `
                <div class="param-item-header" onclick="toggleParameterItem('${paramId}')">
                    <div class="param-item-title">
                        <i class="fas fa-chevron-down param-collapse-icon"></i>
                        <i class="fas fa-${type === 'input' ? 'sign-in-alt' : 'sign-out-alt'}" style="color: ${type === 'input' ? '#28a745' : '#1890ff'}; margin-right: 4px;"></i>
                        <span class="param-name-display">æ–°å»ºå‚æ•°</span>
                    </div>
                    <div class="param-item-actions">
                        <button class="param-item-action" onclick="deleteParameter('${paramId}'); event.stopPropagation();" title="åˆ é™¤å‚æ•°">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="param-content">
                    <div class="param-form-grid">
                        <div class="form-group">
                            <label>åç§° <span style="color: #ff4d4f;">*</span></label>
                            <input type="text" class="param-item-name" placeholder="å‚æ•°åç§°" onchange="updateParameterTitle('${paramId}')" />
                        </div>
                        
                        <div class="form-group">
                            <label>ç±»å‹</label>
                            <select class="param-type-select" onchange="toggleNestedConfig('${paramId}'); updateParameterTitle('${paramId}')">
                                <option value="string">String</option>
                                <option value="number">Number</option>
                                <option value="boolean">Boolean</option>
                                <option value="date">Date</option>
                                <option value="object">Object</option>
                                <option value="array">Array</option>
                                <option value="object_array">Object[]</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>æè¿°</label>
                            <input type="text" placeholder="å‚æ•°æè¿°" class="param-description" />
                        </div>
                    </div>
                    
                    <div class="nested-config" id="nested-${paramId}" style="display: none; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 8px;">
                        <div class="nested-params"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addNestedParameter('${paramId}')">
                            <i class="fas fa-plus"></i> æ·»åŠ å­å‚æ•°
                        </button>
                    </div>
                </div>
            `;
            paramItem.id = paramId;
            return paramItem;
        }

        // åˆ‡æ¢åµŒå¥—é…ç½®æ˜¾ç¤º
        function toggleNestedConfig(paramId) {
            const typeSelect = document.querySelector(`#${paramId} .param-type-select`);
            const nestedConfig = document.getElementById(`nested-${paramId}`);
            const type = typeSelect.value;
            
            if (type === 'object' || type === 'array' || type === 'object_array') {
                nestedConfig.style.display = 'block';
            } else {
                nestedConfig.style.display = 'none';
            }
        }

        // æ·»åŠ åµŒå¥—å‚æ•°
        function addNestedParameter(parentId) {
            const nestedParamsContainer = document.querySelector(`#${parentId} .nested-params`);
            const nestedParam = createNestedParameter(parentId);
            nestedParamsContainer.appendChild(nestedParam);
        }

        // åˆ›å»ºåµŒå¥—å‚æ•°é¡¹
        function createNestedParameter(parentId) {
            const nestedId = `nested-${parentId}-${Date.now()}`;
            const nestedParam = document.createElement('div');
            nestedParam.className = 'nested-param-item';
            nestedParam.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 120px 1fr auto; gap: 8px; align-items: center; padding: 8px;">
                    <input type="text" placeholder="å‚æ•°å" class="nested-param-name" />
                    <select class="nested-param-type">
                        <option value="string">å­—ç¬¦ä¸²</option>
                        <option value="number">æ•°å­—</option>
                        <option value="boolean">å¸ƒå°”å€¼</option>
                        <option value="date">æ—¥æœŸ</option>
                    </select>
                    <input type="text" placeholder="æè¿°" class="nested-param-description" />
                    <button type="button" class="param-item-action" onclick="deleteNestedParameter('${nestedId}')" title="åˆ é™¤å‚æ•°">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            nestedParam.id = nestedId;
            return nestedParam;
        }

        // åˆ é™¤å‚æ•°
        function deleteParameter(paramId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å‚æ•°å—ï¼Ÿ')) {
                document.getElementById(paramId).remove();
                updateParameterCount();
            }
        }

        // åˆ‡æ¢å‚æ•°é¡¹å±•å¼€/æŠ˜å 
        function toggleParameterItem(paramId) {
            const paramItem = document.getElementById(paramId);
            if (paramItem) {
                paramItem.classList.toggle('collapsed');
                
                const content = paramItem.querySelector('.param-content');
                if (content) {
                    if (paramItem.classList.contains('collapsed')) {
                        content.style.maxHeight = '0';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                }
            }
        }

        // åˆ‡æ¢å‚æ•°åˆ†ç»„å±•å¼€/æŠ˜å 
        function toggleParamSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                
                const content = section.querySelector('.param-section-content');
                if (content) {
                    if (section.classList.contains('collapsed')) {
                        content.style.maxHeight = '0';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                }
            }
        }

        // æ›´æ–°å‚æ•°é¡¹æ ‡é¢˜æ˜¾ç¤º
        function updateParameterTitle(paramId) {
            const paramItem = document.getElementById(paramId);
            if (!paramItem) return;
            
            const nameInput = paramItem.querySelector('.param-item-name');
            const typeSelect = paramItem.querySelector('.param-type-select');
            const titleDisplay = paramItem.querySelector('.param-name-display');
            
            if (nameInput && typeSelect && titleDisplay) {
                const name = nameInput.value || 'æ–°å»ºå‚æ•°';
                const type = typeSelect.value || 'string';
                titleDisplay.textContent = `${name} (${type})`;
            }
        }

        // æ›´æ–°å‚æ•°æ•°é‡æ˜¾ç¤º
        function updateParameterCount() {
            // æ›´æ–°è¾“å…¥å‚æ•°æ•°é‡
            const inputParams = document.getElementById('input-params').querySelectorAll('.param-item');
            const inputCount = document.getElementById('input-param-count');
            if (inputCount) {
                inputCount.textContent = `(${inputParams.length})`;
            }
            
            // æ›´æ–°è¾“å‡ºå‚æ•°æ•°é‡
            const outputParams = document.getElementById('output-params').querySelectorAll('.param-item');
            const outputCount = document.getElementById('output-param-count');
            if (outputCount) {
                outputCount.textContent = `(${outputParams.length})`;
            }
        }

        // åˆ é™¤åµŒå¥—å‚æ•°
        function deleteNestedParameter(nestedId) {
            document.getElementById(nestedId).remove();
        }

        // ç¼–è¾‘å‚æ•° (é¢„ç•™åŠŸèƒ½)
        function editParameter(paramId) {
            // TODO: å®ç°å‚æ•°ç¼–è¾‘åŠŸèƒ½
            console.log('ç¼–è¾‘å‚æ•°:', paramId);
        }

        // ä¿å­˜å‚æ•°é…ç½®åˆ°æœåŠ¡æ•°æ®
        function saveParameterConfig() {
            if (!currentService) return;

            const inputParams = collectParameters('input-params');
            const outputParams = collectParameters('output-params');

            // æ›´æ–°å½“å‰æœåŠ¡çš„å‚æ•°é…ç½®
            currentService.requestParams = JSON.stringify(inputParams, null, 2);
            currentService.responseExample = JSON.stringify(outputParams, null, 2);

            showNotification('å‚æ•°é…ç½®å·²æ›´æ–°', 'success');
        }

        // æ”¶é›†å‚æ•°é…ç½®
        function collectParameters(containerId) {
            const container = document.getElementById(containerId);
            const paramItems = container.querySelectorAll('.param-item');
            const params = {};

            paramItems.forEach(item => {
                const nameInput = item.querySelector('.param-item-name');
                const typeSelect = item.querySelector('.param-type-select');
                const descInput = item.querySelector('.param-description');
                
                if (!nameInput.value) return;

                const paramName = nameInput.value;
                const paramType = typeSelect.value;
                const paramDesc = descInput.value;

                params[paramName] = {
                    type: paramType,
                    description: paramDesc
                };

                // å¤„ç†åµŒå¥—å‚æ•°
                const nestedConfig = item.querySelector('.nested-config');
                if (nestedConfig && nestedConfig.style.display !== 'none') {
                    const nestedItems = nestedConfig.querySelectorAll('.nested-param-item');
                    const nestedParams = {};

                    nestedItems.forEach(nestedItem => {
                        const nestedNameInput = nestedItem.querySelector('.nested-param-name');
                        const nestedTypeSelect = nestedItem.querySelector('.nested-param-type');
                        const nestedDescInput = nestedItem.querySelector('.nested-param-description');

                        if (!nestedNameInput.value) return;

                        nestedParams[nestedNameInput.value] = {
                            type: nestedTypeSelect.value,
                            description: nestedDescInput.value
                        };
                    });

                    if (Object.keys(nestedParams).length > 0) {
                        if (paramType === 'object') {
                            params[paramName].properties = nestedParams;
                        } else if (paramType === 'array' || paramType === 'object_array') {
                            params[paramName].items = nestedParams;
                        }
                    }
                }
            });

            return params;
        }

        // ä»æœåŠ¡æ•°æ®åŠ è½½å‚æ•°é…ç½®
        function loadParameterConfig(service) {
            if (!service) return;

            // æ¸…ç©ºç°æœ‰å‚æ•°
            document.getElementById('input-params').innerHTML = '';
            document.getElementById('output-params').innerHTML = '';

            // åŠ è½½è¾“å…¥å‚æ•°
            if (service.requestParams) {
                try {
                    const inputParams = typeof service.requestParams === 'string' 
                        ? JSON.parse(service.requestParams) 
                        : service.requestParams;
                    renderParameters('input-params', inputParams);
                } catch (e) {
                    console.error('è§£æè¾“å…¥å‚æ•°å¤±è´¥:', e);
                }
            }

            // åŠ è½½è¾“å‡ºå‚æ•°
            if (service.responseExample) {
                try {
                    const outputParams = typeof service.responseExample === 'string' 
                        ? JSON.parse(service.responseExample) 
                        : service.responseExample;
                    renderParameters('output-params', outputParams);
                } catch (e) {
                    console.error('è§£æè¾“å‡ºå‚æ•°å¤±è´¥:', e);
                }
            }
            
            // åŠ è½½å®Œæˆåæ›´æ–°è®¡æ•°
            setTimeout(() => {
                updateParameterCount();
            }, 100);
        }

        // è¾…åŠ©å‡½æ•°
        function getMethodClass(method) {
            const classes = {
                'GET': 'get',
                'POST': 'post', 
                'PUT': 'put',
                'DELETE': 'delete'
            };
            return classes[method] || 'get';
        }
        
        function getDatabaseIcon(type) {
            const icons = {
                'H2': 'fas fa-database',
                'MYSQL': 'fab fa-mysql',
                'POSTGRESQL': 'fas fa-elephant',
                'ORACLE': 'fas fa-building',
                'MONGODB': 'fab fa-leaf',
                'ELASTICSEARCH': 'fas fa-search',
                'CLICKHOUSE': 'fas fa-chart-bar'
            };
            return icons[type] || 'fas fa-database';
        }
        
        function getStatusClass(status, type) {
            if (type === 'service') {
                const classes = {
                    'DRAFT': 'status-draft',
                    'PUBLISHED': 'status-published',
                    'DISABLED': 'status-disabled'
                };
                return classes[status] || 'status-draft';
            }
            return '';
        }
        
        function getStatusText(status, type) {
            if (type === 'service') {
                const texts = {
                    'DRAFT': 'è‰ç¨¿',
                    'PUBLISHED': 'å·²å‘å¸ƒ',
                    'DISABLED': 'å·²ç¦ç”¨'
                };
                return texts[status] || 'è‰ç¨¿';
            }
            return status;
        }
        
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // æ¸²æŸ“å‚æ•°é…ç½®
        function renderParameters(containerId, params) {
            const container = document.getElementById(containerId);
            const paramType = containerId === 'input-params' ? 'input' : 'output';

            Object.keys(params).forEach(paramName => {
                const param = params[paramName];
                const paramItem = createParameterItem(paramType);
                
                // å¡«å……å‚æ•°åŸºæœ¬ä¿¡æ¯
                const nameInput = paramItem.querySelector('.param-item-name');
                const typeSelect = paramItem.querySelector('.param-type-select');
                const descInput = paramItem.querySelector('.param-description');
                
                nameInput.value = paramName;
                typeSelect.value = param.type || 'string';
                descInput.value = param.description || '';

                // å¦‚æœæœ‰åµŒå¥—å‚æ•°ï¼Œæ˜¾ç¤ºå¹¶å¡«å……
                if (param.properties || param.items) {
                    const nestedConfig = paramItem.querySelector('.nested-config');
                    nestedConfig.style.display = 'block';
                    
                    const nestedParamsContainer = paramItem.querySelector('.nested-params');
                    const nestedData = param.properties || param.items;
                    
                    Object.keys(nestedData).forEach(nestedName => {
                        const nestedParam = nestedData[nestedName];
                        const nestedItem = createNestedParameter(paramItem.id);
                        
                        const nestedNameInput = nestedItem.querySelector('.nested-param-name');
                        const nestedTypeSelect = nestedItem.querySelector('.nested-param-type');
                        const nestedDescInput = nestedItem.querySelector('.nested-param-description');
                        
                        nestedNameInput.value = nestedName;
                        nestedTypeSelect.value = nestedParam.type || 'string';
                        nestedDescInput.value = nestedParam.description || '';
                        
                        nestedParamsContainer.appendChild(nestedItem);
                    });
                }

                container.appendChild(paramItem);
            });
            
            updateParameterCount();
        }
    </script>
</body>
</html>