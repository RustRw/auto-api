<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•æ•°æ®æºçº§è”ä¸‹æ‹‰</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { padding: 8px; width: 300px; font-size: 14px; }
        #log { background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>æ•°æ®æºç±»å‹çº§è”æµ‹è¯•</h1>
    
    <div class="step">
        <h3>æ­¥éª¤1ï¼šç™»å½•å¹¶è·å–æ•°æ®æº</h3>
        <button onclick="initialize()">åˆå§‹åŒ–</button>
        <span id="init-status">ç­‰å¾…åˆå§‹åŒ–</span>
    </div>
    
    <div class="step">
        <h3>æ­¥éª¤2ï¼šé€‰æ‹©æ•°æ®æºç±»å‹</h3>
        <div class="form-group">
            <label for="new-datasource-type">æ•°æ®æºç±»å‹:</label>
            <select id="new-datasource-type" onchange="filterDatasourcesByType()">
                <option value="">è¯·é€‰æ‹©æ•°æ®æºç±»å‹</option>
                <option value="MYSQL">ğŸ¬ MySQL</option>
                <option value="POSTGRESQL">ğŸ˜ PostgreSQL</option>
                <option value="H2">ğŸ’¾ H2</option>
                <option value="ORACLE">ğŸ¢ Oracle</option>
                <option value="MONGODB">ğŸƒ MongoDB</option>
                <option value="ELASTICSEARCH">ğŸ” Elasticsearch</option>
                <option value="CLICKHOUSE">ğŸ“Š ClickHouse</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="new-service-datasource">æ•°æ®æº:</label>
            <select id="new-service-datasource">
                <option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æºç±»å‹</option>
            </select>
        </div>
    </div>
    
    <div class="step">
        <h3>æ­¥éª¤3ï¼šè°ƒè¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log"></div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let datasources = [];
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function initialize() {
            const statusSpan = document.getElementById('init-status');
            statusSpan.textContent = 'åˆå§‹åŒ–ä¸­...';
            statusSpan.style.color = 'orange';
            
            try {
                log('å¼€å§‹åˆå§‹åŒ–...');
                
                // ç™»å½•
                log('æ­£åœ¨ç™»å½•...');
                const loginResponse = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const loginResult = await loginResponse.json();
                if (loginResult.success) {
                    const token = loginResult.data.token;
                    localStorage.setItem('token', token);
                    log('âœ… ç™»å½•æˆåŠŸ');
                    
                    // åŠ è½½æ•°æ®æº
                    log('æ­£åœ¨åŠ è½½æ•°æ®æº...');
                    const dsResponse = await fetch(`${API_BASE_URL}/api/datasources`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (dsResponse.ok) {
                        const dsResult = await dsResponse.json();
                        if (dsResult.success) {
                            datasources = dsResult.data;
                            log(`âœ… æ•°æ®æºåŠ è½½æˆåŠŸï¼Œå…±${datasources.length}ä¸ª`);
                            datasources.forEach(ds => {
                                log(`  - ${ds.name}: ${ds.type} @ ${ds.host}:${ds.port} (ID: ${ds.id})`);
                            });
                            statusSpan.textContent = 'âœ… åˆå§‹åŒ–æˆåŠŸ';
                            statusSpan.style.color = 'green';
                        } else {
                            throw new Error('æ•°æ®æºAPIè¿”å›å¤±è´¥: ' + dsResult.message);
                        }
                    } else {
                        throw new Error('æ•°æ®æºAPIè¯·æ±‚å¤±è´¥: HTTP ' + dsResponse.status);
                    }
                } else {
                    throw new Error('ç™»å½•å¤±è´¥: ' + loginResult.message);
                }
            } catch (error) {
                log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                statusSpan.textContent = 'âŒ åˆå§‹åŒ–å¤±è´¥';
                statusSpan.style.color = 'red';
            }
        }
        
        // æ•°æ®æºç±»å‹å˜æ›´æ—¶ç­›é€‰æ•°æ®æº
        function filterDatasourcesByType() {
            log('filterDatasourcesByType è¢«è°ƒç”¨');
            const typeSelect = document.getElementById('new-datasource-type');
            const datasourceSelect = document.getElementById('new-service-datasource');
            
            if (!typeSelect || !datasourceSelect) {
                log('âŒ æ•°æ®æºé€‰æ‹©æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            const selectedType = typeSelect.value;
            log(`é€‰æ‹©çš„æ•°æ®æºç±»å‹: "${selectedType}"`);
            log(`å½“å‰å…¨å±€æ•°æ®æºæ•°é‡: ${datasources ? datasources.length : 0}`);
            
            // é‡ç½®æ•°æ®æºé€‰æ‹©æ¡†
            datasourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®æº</option>';
            
            if (!selectedType) {
                datasourceSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æºç±»å‹</option>';
                log('æœªé€‰æ‹©æ•°æ®æºç±»å‹ï¼Œå·²é‡ç½®é€‰æ‹©æ¡†');
                return;
            }
            
            if (!datasources || datasources.length === 0) {
                log('âŒ å…¨å±€æ•°æ®æºæ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰');
                datasourceSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨æ•°æ®æº</option>';
                return;
            }
            
            log('å¼€å§‹ç­›é€‰æ•°æ®æº...');
            const filteredDatasources = datasources.filter(ds => {
                log(`  æ£€æŸ¥æ•°æ®æº: ${ds.name} (ç±»å‹: ${ds.type}) æ˜¯å¦åŒ¹é… "${selectedType}"`);
                return ds.type === selectedType;
            });
            
            log(`ç­›é€‰ç»“æœ: ${filteredDatasources.length}ä¸ªæ•°æ®æºåŒ¹é…`);
            
            if (filteredDatasources.length === 0) {
                log('è¯¥ç±»å‹æ²¡æœ‰åŒ¹é…çš„æ•°æ®æº');
                datasourceSelect.innerHTML = '<option value="">è¯¥ç±»å‹æš‚æ— å¯ç”¨æ•°æ®æº</option>';
                return;
            }
            
            log('å¼€å§‹å¡«å……æ•°æ®æºé€‰é¡¹:');
            filteredDatasources.forEach(ds => {
                log(`  æ·»åŠ é€‰é¡¹: ${ds.name} (ID: ${ds.id})`);
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = `${ds.name} (${ds.host}:${ds.port})`;
                datasourceSelect.appendChild(option);
            });
            
            log('âœ… æ•°æ®æºé€‰é¡¹å¡«å……å®Œæˆ');
            log(`æœ€ç»ˆé€‰é¡¹æ•°é‡: ${datasourceSelect.options.length - 1}ä¸ªé€‰é¡¹ï¼ˆé™¤äº†é»˜è®¤é€‰é¡¹ï¼‰`);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>