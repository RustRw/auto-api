<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试数据源级联下拉</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { padding: 8px; width: 300px; font-size: 14px; }
        #log { background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>数据源类型级联测试</h1>
    
    <div class="step">
        <h3>步骤1：登录并获取数据源</h3>
        <button onclick="initialize()">初始化</button>
        <span id="init-status">等待初始化</span>
    </div>
    
    <div class="step">
        <h3>步骤2：选择数据源类型</h3>
        <div class="form-group">
            <label for="new-datasource-type">数据源类型:</label>
            <select id="new-datasource-type" onchange="filterDatasourcesByType()">
                <option value="">请选择数据源类型</option>
                <option value="MYSQL">🐬 MySQL</option>
                <option value="POSTGRESQL">🐘 PostgreSQL</option>
                <option value="H2">💾 H2</option>
                <option value="ORACLE">🏢 Oracle</option>
                <option value="MONGODB">🍃 MongoDB</option>
                <option value="ELASTICSEARCH">🔍 Elasticsearch</option>
                <option value="CLICKHOUSE">📊 ClickHouse</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="new-service-datasource">数据源:</label>
            <select id="new-service-datasource">
                <option value="">请先选择数据源类型</option>
            </select>
        </div>
    </div>
    
    <div class="step">
        <h3>步骤3：调试日志</h3>
        <button onclick="clearLog()">清空日志</button>
        <div id="log"></div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let datasources = [];
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function initialize() {
            const statusSpan = document.getElementById('init-status');
            statusSpan.textContent = '初始化中...';
            statusSpan.style.color = 'orange';
            
            try {
                log('开始初始化...');
                
                // 登录
                log('正在登录...');
                const loginResponse = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const loginResult = await loginResponse.json();
                if (loginResult.success) {
                    const token = loginResult.data.token;
                    localStorage.setItem('token', token);
                    log('✅ 登录成功');
                    
                    // 加载数据源
                    log('正在加载数据源...');
                    const dsResponse = await fetch(`${API_BASE_URL}/api/datasources`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (dsResponse.ok) {
                        const dsResult = await dsResponse.json();
                        if (dsResult.success) {
                            datasources = dsResult.data;
                            log(`✅ 数据源加载成功，共${datasources.length}个`);
                            datasources.forEach(ds => {
                                log(`  - ${ds.name}: ${ds.type} @ ${ds.host}:${ds.port} (ID: ${ds.id})`);
                            });
                            statusSpan.textContent = '✅ 初始化成功';
                            statusSpan.style.color = 'green';
                        } else {
                            throw new Error('数据源API返回失败: ' + dsResult.message);
                        }
                    } else {
                        throw new Error('数据源API请求失败: HTTP ' + dsResponse.status);
                    }
                } else {
                    throw new Error('登录失败: ' + loginResult.message);
                }
            } catch (error) {
                log('❌ 初始化失败: ' + error.message);
                statusSpan.textContent = '❌ 初始化失败';
                statusSpan.style.color = 'red';
            }
        }
        
        // 数据源类型变更时筛选数据源
        function filterDatasourcesByType() {
            log('filterDatasourcesByType 被调用');
            const typeSelect = document.getElementById('new-datasource-type');
            const datasourceSelect = document.getElementById('new-service-datasource');
            
            if (!typeSelect || !datasourceSelect) {
                log('❌ 数据源选择框元素未找到');
                return;
            }
            
            const selectedType = typeSelect.value;
            log(`选择的数据源类型: "${selectedType}"`);
            log(`当前全局数据源数量: ${datasources ? datasources.length : 0}`);
            
            // 重置数据源选择框
            datasourceSelect.innerHTML = '<option value="">请选择数据源</option>';
            
            if (!selectedType) {
                datasourceSelect.innerHTML = '<option value="">请先选择数据源类型</option>';
                log('未选择数据源类型，已重置选择框');
                return;
            }
            
            if (!datasources || datasources.length === 0) {
                log('❌ 全局数据源数组为空或未定义');
                datasourceSelect.innerHTML = '<option value="">暂无可用数据源</option>';
                return;
            }
            
            log('开始筛选数据源...');
            const filteredDatasources = datasources.filter(ds => {
                log(`  检查数据源: ${ds.name} (类型: ${ds.type}) 是否匹配 "${selectedType}"`);
                return ds.type === selectedType;
            });
            
            log(`筛选结果: ${filteredDatasources.length}个数据源匹配`);
            
            if (filteredDatasources.length === 0) {
                log('该类型没有匹配的数据源');
                datasourceSelect.innerHTML = '<option value="">该类型暂无可用数据源</option>';
                return;
            }
            
            log('开始填充数据源选项:');
            filteredDatasources.forEach(ds => {
                log(`  添加选项: ${ds.name} (ID: ${ds.id})`);
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = `${ds.name} (${ds.host}:${ds.port})`;
                datasourceSelect.appendChild(option);
            });
            
            log('✅ 数据源选项填充完成');
            log(`最终选项数量: ${datasourceSelect.options.length - 1}个选项（除了默认选项）`);
        }
        
        // 页面加载完成后自动初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成');
        });
    </script>
</body>
</html>