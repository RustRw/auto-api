<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ•°æ®æºç±»å‹è”åŠ¨åŠŸèƒ½</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { padding: 8px; width: 300px; }
        #debug { background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>æ•°æ®æºç±»å‹è”åŠ¨æµ‹è¯•</h1>
    
    <div class="form-group">
        <label for="datasource-type">æ•°æ®æºç±»å‹:</label>
        <select id="datasource-type" onchange="filterDatasources()">
            <option value="">è¯·é€‰æ‹©æ•°æ®æºç±»å‹</option>
            <option value="MYSQL">ğŸ¬ MySQL</option>
            <option value="POSTGRESQL">ğŸ˜ PostgreSQL</option>
            <option value="H2">ğŸ’¾ H2</option>
            <option value="ORACLE">ğŸ¢ Oracle</option>
            <option value="MONGODB">ğŸƒ MongoDB</option>
            <option value="ELASTICSEARCH">ğŸ” Elasticsearch</option>
            <option value="CLICKHOUSE">ğŸ“Š ClickHouse</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="datasource-select">æ•°æ®æº:</label>
        <select id="datasource-select">
            <option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æºç±»å‹</option>
        </select>
    </div>
    
    <div id="debug">
        <h3>è°ƒè¯•ä¿¡æ¯:</h3>
        <div id="debug-output"></div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let datasources = [];
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®æº
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // é¦–å…ˆç™»å½•è·å–token
                const loginResponse = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const loginResult = await loginResponse.json();
                if (loginResult.success) {
                    const token = loginResult.data.token;
                    localStorage.setItem('token', token);
                    log('ç™»å½•æˆåŠŸï¼ŒTokenå·²ä¿å­˜');
                    
                    // åŠ è½½æ•°æ®æº
                    await loadDataSources();
                } else {
                    log('ç™»å½•å¤±è´¥: ' + loginResult.message);
                }
            } catch (error) {
                log('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });
        
        async function loadDataSources() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/datasources`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        datasources = result.data;
                        log(`å·²åŠ è½½æ•°æ®æº: ${datasources.length}ä¸ª`);
                        datasources.forEach(ds => {
                            log(`- ${ds.name}: ${ds.type} @ ${ds.host}:${ds.port}`);
                        });
                    } else {
                        log('åŠ è½½æ•°æ®æºå¤±è´¥: ' + result.message);
                    }
                } else {
                    log('APIè¯·æ±‚å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                log('åŠ è½½æ•°æ®æºå¼‚å¸¸: ' + error.message);
            }
        }
        
        function filterDatasources() {
            const typeSelect = document.getElementById('datasource-type');
            const datasourceSelect = document.getElementById('datasource-select');
            const selectedType = typeSelect.value;
            
            log(`é€‰æ‹©çš„æ•°æ®æºç±»å‹: ${selectedType}`);
            log(`å½“å‰å…¨å±€æ•°æ®æºæ•°é‡: ${datasources ? datasources.length : 0}`);
            
            datasourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®æº</option>';
            
            if (!selectedType) {
                datasourceSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æºç±»å‹</option>';
                log('æœªé€‰æ‹©æ•°æ®æºç±»å‹ï¼Œå·²é‡ç½®é€‰æ‹©æ¡†');
                return;
            }
            
            if (!datasources || datasources.length === 0) {
                log('å…¨å±€æ•°æ®æºæ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰');
                datasourceSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨æ•°æ®æº</option>';
                return;
            }
            
            const filteredDatasources = datasources.filter(ds => ds.type === selectedType);
            log(`ç­›é€‰åˆ°çš„æ•°æ®æº: ${filteredDatasources.length}ä¸ª`);
            
            if (filteredDatasources.length === 0) {
                log('è¯¥ç±»å‹æ²¡æœ‰åŒ¹é…çš„æ•°æ®æº');
                datasourceSelect.innerHTML = '<option value="">è¯¥ç±»å‹æš‚æ— å¯ç”¨æ•°æ®æº</option>';
                return;
            }
            
            log('å¼€å§‹å¡«å……æ•°æ®æºé€‰é¡¹:');
            filteredDatasources.forEach(ds => {
                log(`æ·»åŠ é€‰é¡¹: ${ds.name} (ID: ${ds.id})`);
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = `${ds.name} (${ds.host}:${ds.port})`;
                datasourceSelect.appendChild(option);
            });
            log('æ•°æ®æºé€‰é¡¹å¡«å……å®Œæˆ');
        }
        
        function log(message) {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
    </script>
</body>
</html>