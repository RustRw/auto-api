<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试数据源类型联动功能</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { padding: 8px; width: 300px; }
        #debug { background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>数据源类型联动测试</h1>
    
    <div class="form-group">
        <label for="datasource-type">数据源类型:</label>
        <select id="datasource-type" onchange="filterDatasources()">
            <option value="">请选择数据源类型</option>
            <option value="MYSQL">🐬 MySQL</option>
            <option value="POSTGRESQL">🐘 PostgreSQL</option>
            <option value="H2">💾 H2</option>
            <option value="ORACLE">🏢 Oracle</option>
            <option value="MONGODB">🍃 MongoDB</option>
            <option value="ELASTICSEARCH">🔍 Elasticsearch</option>
            <option value="CLICKHOUSE">📊 ClickHouse</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="datasource-select">数据源:</label>
        <select id="datasource-select">
            <option value="">请先选择数据源类型</option>
        </select>
    </div>
    
    <div id="debug">
        <h3>调试信息:</h3>
        <div id="debug-output"></div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let datasources = [];
        
        // 页面加载时获取数据源
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 首先登录获取token
                const loginResponse = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const loginResult = await loginResponse.json();
                if (loginResult.success) {
                    const token = loginResult.data.token;
                    localStorage.setItem('token', token);
                    log('登录成功，Token已保存');
                    
                    // 加载数据源
                    await loadDataSources();
                } else {
                    log('登录失败: ' + loginResult.message);
                }
            } catch (error) {
                log('初始化失败: ' + error.message);
            }
        });
        
        async function loadDataSources() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/datasources`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        datasources = result.data;
                        log(`已加载数据源: ${datasources.length}个`);
                        datasources.forEach(ds => {
                            log(`- ${ds.name}: ${ds.type} @ ${ds.host}:${ds.port}`);
                        });
                    } else {
                        log('加载数据源失败: ' + result.message);
                    }
                } else {
                    log('API请求失败: HTTP ' + response.status);
                }
            } catch (error) {
                log('加载数据源异常: ' + error.message);
            }
        }
        
        function filterDatasources() {
            const typeSelect = document.getElementById('datasource-type');
            const datasourceSelect = document.getElementById('datasource-select');
            const selectedType = typeSelect.value;
            
            log(`选择的数据源类型: ${selectedType}`);
            log(`当前全局数据源数量: ${datasources ? datasources.length : 0}`);
            
            datasourceSelect.innerHTML = '<option value="">请选择数据源</option>';
            
            if (!selectedType) {
                datasourceSelect.innerHTML = '<option value="">请先选择数据源类型</option>';
                log('未选择数据源类型，已重置选择框');
                return;
            }
            
            if (!datasources || datasources.length === 0) {
                log('全局数据源数组为空或未定义');
                datasourceSelect.innerHTML = '<option value="">暂无可用数据源</option>';
                return;
            }
            
            const filteredDatasources = datasources.filter(ds => ds.type === selectedType);
            log(`筛选到的数据源: ${filteredDatasources.length}个`);
            
            if (filteredDatasources.length === 0) {
                log('该类型没有匹配的数据源');
                datasourceSelect.innerHTML = '<option value="">该类型暂无可用数据源</option>';
                return;
            }
            
            log('开始填充数据源选项:');
            filteredDatasources.forEach(ds => {
                log(`添加选项: ${ds.name} (ID: ${ds.id})`);
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = `${ds.name} (${ds.host}:${ds.port})`;
                datasourceSelect.appendChild(option);
            });
            log('数据源选项填充完成');
        }
        
        function log(message) {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
    </script>
</body>
</html>